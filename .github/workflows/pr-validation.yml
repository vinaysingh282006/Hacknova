name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install linting tools
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard eslint @eslint/js

      - name: Create ESLint config
        run: |
          cat > eslint.config.mjs << 'EOF'
          import js from "@eslint/js";
          export default [
            js.configs.recommended,
            {
              languageOptions: {
                ecmaVersion: 2022,
                sourceType: "module",
                globals: {
                  window: "readonly",
                  document: "readonly",
                  console: "readonly",
                  setTimeout: "readonly",
                  setInterval: "readonly",
                  clearInterval: "readonly",
                  clearTimeout: "readonly",
                  requestAnimationFrame: "readonly",
                  cancelAnimationFrame: "readonly",
                  fetch: "readonly",
                  THREE: "readonly",
                  tailwind: "readonly",
                  Chart: "readonly",
                  gsap: "readonly",
                  ScrollTrigger: "readonly",
                  tf: "readonly"
                }
              },
              rules: {
                "no-unused-vars": "warn",
                "no-undef": "error"
              }
            }
          ];
          EOF

      - name: Create StyleLint config
        run: |
          cat > .stylelintrc.json << 'EOF'
          {
            "extends": "stylelint-config-standard",
            "rules": {
              "no-descending-specificity": null,
              "selector-class-pattern": null,
              "custom-property-pattern": null,
              "keyframes-name-pattern": null,
              "alpha-value-notation": null,
              "color-function-notation": null
            }
          }
          EOF

      - name: Create HTMLHint config
        run: |
          cat > .htmlhintrc << 'EOF'
          {
            "tagname-lowercase": true,
            "attr-lowercase": true,
            "attr-value-double-quotes": true,
            "doctype-first": true,
            "tag-pair": true,
            "spec-char-escape": false,
            "id-unique": true,
            "src-not-empty": true,
            "attr-no-duplication": true,
            "title-require": true
          }
          EOF

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.html
            **/*.css
            **/*.js

      - name: Lint changed HTML files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          html_files=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep '\.html$' || true)
          if [ -n "$html_files" ]; then
            echo "Linting HTML files: $html_files"
            echo "$html_files" | xargs htmlhint --format compact
          else
            echo "No HTML files changed"
          fi

      - name: Lint changed CSS files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          css_files=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep '\.css$' || true)
          if [ -n "$css_files" ]; then
            echo "Linting CSS files: $css_files"
            echo "$css_files" | xargs stylelint --formatter compact
          else
            echo "No CSS files changed"
          fi

      - name: Lint changed JS files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          js_files=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep '\.js$' || true)
          if [ -n "$js_files" ]; then
            echo "Linting JS files: $js_files"
            echo "$js_files" | xargs npx eslint --format compact
          else
            echo "No JS files changed"
          fi

  check-linked-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Check for linked issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            
            // Check for issue references
            const issueRegex = /(close[sd]?|fix(e[sd])?|resolve[sd]?)?\s*#(\d+)/gi;
            const matches = body.match(issueRegex);
            
            if (!matches || matches.length === 0) {
              core.setFailed("PR must reference an issue. Use 'Fixes #123' or 'Closes #123' in the PR description.");
              return;
            }
            
            // Extract issue numbers
            const issueNumbers = [];
            let match;
            const regex = /#(\d+)/g;
            while ((match = regex.exec(body)) !== null) {
              issueNumbers.push(parseInt(match[1]));
            }
            
            console.log(`Found linked issues: ${issueNumbers.join(', ')}`);
            
            // Verify issues exist and check their labels
            for (const issueNum of issueNumbers) {
              try {
                const issue = await github.rest.issues.get({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNum
                });
                
                const labels = issue.data.labels.map(l => l.name);
                console.log(`Issue #${issueNum} labels: ${labels.join(', ')}`);
                
                // Add corresponding labels to PR
                const labelsToAdd = [];
                if (labels.includes('bug')) {
                  labelsToAdd.push('bug-fix');
                }
                if (labels.includes('enhancement') || labels.includes('feature')) {
                  labelsToAdd.push('feature');
                }
                
                if (labelsToAdd.length > 0) {
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: labelsToAdd
                  });
                }
              } catch (error) {
                console.log(`Warning: Could not fetch issue #${issueNum}: ${error.message}`);
              }
            }

  status-check:
    runs-on: ubuntu-latest
    needs: [lint-changes, check-linked-issue]
    steps:
      - name: All checks passed
        run: |
          echo "âœ… All PR validation checks passed!"
          echo "- Linting: Passed"
          echo "- Issue linkage: Verified"
